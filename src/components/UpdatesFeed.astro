---
import { getCollection } from 'astro:content';

interface Props {
  limit?: number;
  excludedProjectIds?: Set<string>;
  mode?: 'latest' | 'random';
}

const { limit = 3, excludedProjectIds = new Set(), mode = 'latest' } = Astro.props;

// Gather all posts from different collections
const allJourney = await getCollection('journey', ({ data }) => data.draft !== true);
const allProjects = await getCollection('projects', ({ data }) => data.draft !== true);
const allPublications = await getCollection('publications', ({ data }) => data.draft === false);
const allTools = await getCollection('tools', ({ data }) => data.draft !== true);

// Unify all posts with a common structure
const allPosts = [
  ...allJourney.map(entry => ({
    type: 'journey' as const,
    date: entry.data.date,
    title: entry.data.title,
    description: entry.data.description,
    link: `/journey#${entry.id}`,
    meta: entry.data.type,
    tags: entry.data.skills?.slice(0, 3),
  })),
  ...allProjects
    .filter(project => !excludedProjectIds.has(project.id))
    .map(project => ({
      type: 'project' as const,
      date: new Date(project.data.year, 0, 1),
      title: project.data.title,
      description: project.data.outcomeSummary,
      link: `/projects/${project.id}`,
      meta: project.data.role,
      tags: project.data.techStack?.slice(0, 3),
    })),
  ...allPublications.map(pub => ({
    type: 'publication' as const,
    date: pub.data.publishDate,
    title: pub.data.title,
    description: pub.data.journal,
    link: pub.data.doi || '#',
    meta: `${pub.data.citedByCount} citations`,
    tags: pub.data.tags?.slice(0, 3),
  })),
  ...allTools.map(tool => ({
    type: 'tool' as const,
    date: tool.data.date,
    title: tool.data.name,
    description: tool.data.description,
    link: `/tools#${tool.id}`,
    meta: tool.data.best_for,
    tags: tool.data.tags?.slice(0, 3),
  })),
];

// Select posts based on mode
let selectedPosts;
if (mode === 'random') {
  // Fisher-Yates shuffle algorithm
  const shuffled = [...allPosts];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  selectedPosts = shuffled.slice(0, limit);
} else {
  // Latest mode - sort by date descending
  selectedPosts = allPosts
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, limit);
}
---

<section class="latest-updates">
  <div class="latest-header">
    <h2>{mode === 'random' ? 'Random Updates' : 'Latest Updates'}</h2>
  </div>
  <div class="latest-grid">
    {selectedPosts.map((post) => {
      const formattedDate = post.date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      const isExternal = post.type === 'publication';
      const linkProps = isExternal && post.link !== '#' 
        ? { target: '_blank', rel: 'noopener noreferrer' } 
        : {};
      
      // Truncate description to 20 words if longer
      const words = post.description.split(/\s+/);
      const truncatedDescription = words.length > 10 
        ? words.slice(0, 10).join(' ') + '...'
        : post.description;
      
      return (
        <a href={post.link} class="latest-card" {...linkProps}>
          <div class="latest-meta">
            <span class="latest-date">{formattedDate}</span>
            <span class="latest-type" data-type={post.type}>
              {post.type}
            </span>
          </div>
          <h3 class="latest-title">{post.title}</h3>
          <p class="latest-description">{truncatedDescription}</p>
          {post.tags && post.tags.length > 0 && (
            <div class="latest-skills">
              {post.tags.map((tag) => (
                <span class="skill-tag">{tag}</span>
              ))}
            </div>
          )}
        </a>
      );
    })}
  </div>
</section>

<style>
  .latest-updates {
    padding: 4rem 0;
    border-top: 1px solid var(--color-border);
  }

  .latest-header {
    margin-bottom: 2rem;
  }

  .latest-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .latest-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .latest-card {
    padding: 1.5rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: border-color 0.2s ease, background 0.2s ease;
    text-decoration: none;
    display: block;
  }

  .latest-card:hover {
    border-color: var(--color-text-muted);
    background: var(--color-bg-elevated);
  }

  .latest-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    gap: 0.5rem;
  }

  .latest-date {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-variant-numeric: tabular-nums;
  }

  .latest-type {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    font-weight: 600;
    text-transform: capitalize;
  }

  .latest-type[data-type="journey"] {
    background: rgba(139, 92, 246, 0.1);
    color: rgb(139, 92, 246);
  }

  .latest-type[data-type="project"] {
    background: var(--color-accent-muted);
    color: var(--color-accent);
  }

  .latest-type[data-type="publication"] {
    background: rgba(34, 139, 230, 0.1);
    color: rgb(34, 139, 230);
  }

  .latest-type[data-type="tool"] {
    background: rgba(16, 185, 129, 0.1);
    color: rgb(16, 185, 129);
  }

  .latest-type[data-type="milestone"] {
    background: var(--color-accent-muted);
    color: var(--color-accent);
  }

  .latest-type[data-type="learning"] {
    background: rgba(34, 139, 230, 0.1);
    color: rgb(34, 139, 230);
  }

  .latest-type[data-type="transition"] {
    background: rgba(139, 92, 246, 0.1);
    color: rgb(139, 92, 246);
  }

  .latest-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    line-height: 1.4;
    color: var(--color-text);
  }

  .latest-description {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
    margin-bottom: 0.75rem;
  }

  .latest-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .skill-tag {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    background: var(--color-bg);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .skill-more {
    background: transparent;
  }

  @media (max-width: 768px) {
    .latest-updates {
      padding: 3rem 0;
    }

    .latest-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }
</style>
