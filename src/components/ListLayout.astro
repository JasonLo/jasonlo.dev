---
import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from './SEO.astro';
import PageStats from './PageStats.astro';

interface SortOption {
  key: string;
  label: string;
}

interface Props {
  title: string;
  intro: string;
  itemCount: number;
  itemLabel: string;
  statsExtra?: string;
  sortOptions?: SortOption[];
  defaultSort?: string;
  listId: string;
  emptyMessage: string;
  description: string;
  pageSize?: number;
}

const { title, intro, itemCount, itemLabel, statsExtra, sortOptions, defaultSort, listId, emptyMessage, description, pageSize } = Astro.props;
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={description}
    type="website"
  />

  <div class="page-container">
    <header class="page-header">
      <h1 class="page-title">{title}</h1>
      <p class="page-intro">
        {intro}
      </p>
      <div class="page-controls">
        <PageStats text={`${itemCount} ${itemLabel}${statsExtra ? ` · ${statsExtra}` : ''}`} />
        {sortOptions && sortOptions.length > 0 && (
          <div class="sort-controls" role="group" aria-labelledby="sort-label">
            <span class="sort-label" id="sort-label">Sort by</span>
            {sortOptions.map((option) => (
              <button
                type="button"
                class:list={['sort-btn', { active: option.key === defaultSort }]}
                data-sort-key={option.key}
                aria-pressed={option.key === defaultSort}
              >
                {option.label}
              </button>
            ))}
          </div>
        )}
        <div role="status" class="sort-status visually-hidden" aria-live="polite" aria-atomic="true"></div>
      </div>
    </header>

    {itemCount > 0 ? (
      <div class="row-list" id={listId}>
        <slot />
      </div>
    ) : (
      <p class="empty-state">{emptyMessage}</p>
    )}
    {pageSize && itemCount > pageSize && (
      <nav class="pagination" aria-label="Page navigation" id={`${listId}-pagination`} data-page-size={pageSize}>
        <button type="button" class="page-btn" id={`${listId}-prev`} aria-label="Previous page" disabled>← Prev</button>
        <span class="page-indicator" aria-live="polite" aria-atomic="true">
          Page <span id={`${listId}-page-current`}>1</span> of <span id={`${listId}-page-total`}>{Math.ceil(itemCount / pageSize)}</span>
        </span>
        <button type="button" class="page-btn" id={`${listId}-next`} aria-label="Next page">Next →</button>
      </nav>
    )}
  </div>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.sort-controls').forEach((controls) => {
      const list = controls.closest('.page-container')?.querySelector('.row-list');
      if (!list) return;

      controls.querySelectorAll('.sort-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-sort-key');
          if (!key) return;

          controls.querySelectorAll('.sort-btn').forEach((b) => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');

          const statusEl = controls.closest('.page-container')?.querySelector('.sort-status');
          if (statusEl) statusEl.textContent = `Sorted by ${btn.textContent?.trim() ?? key}`;

          const items = [...list.querySelectorAll('.row-item')];
          const vals = items.map((el) => el.getAttribute('data-sort-' + key) || '');
          const numeric = vals.every((v) => v !== '' && !isNaN(Number(v)));

          const indices = items.map((_, i) => i);
          indices.sort((a, b) =>
            numeric ? Number(vals[b]) - Number(vals[a]) : vals[a].localeCompare(vals[b])
          );
          indices.forEach((i) => list.appendChild(items[i]));
        });
      });
    });

    // Pagination
    document.querySelectorAll('.row-list').forEach((list) => {
      const listId = list.id;
      const pagination = document.getElementById(listId + '-pagination');
      if (!pagination) return;

      const pageSizeAttr = (pagination as HTMLElement).dataset.pageSize;
      const pageSize = pageSizeAttr ? parseInt(pageSizeAttr, 10) : 10;
      let currentPage = 1;

      function getItems() {
        return Array.from(list.querySelectorAll('.row-item'));
      }

      function applyPage() {
        const items = getItems();
        const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
        currentPage = Math.min(currentPage, totalPages);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        items.forEach((item, i) => {
          (item as HTMLElement).style.display = i >= start && i < end ? '' : 'none';
        });
        const cur = document.getElementById(listId + '-page-current');
        const tot = document.getElementById(listId + '-page-total');
        const prev = document.getElementById(listId + '-prev') as HTMLButtonElement | null;
        const next = document.getElementById(listId + '-next') as HTMLButtonElement | null;
        if (cur) cur.textContent = String(currentPage);
        if (tot) tot.textContent = String(totalPages);
        if (prev) prev.disabled = currentPage === 1;
        if (next) next.disabled = currentPage === totalPages;
      }

      applyPage();

      document.getElementById(listId + '-prev')?.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          applyPage();
          list.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });

      document.getElementById(listId + '-next')?.addEventListener('click', () => {
        const totalPages = Math.ceil(getItems().length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          applyPage();
          list.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });

      // Reset to page 1 after sort
      list.closest('.page-container')?.querySelectorAll('.sort-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          queueMicrotask(() => { currentPage = 1; applyPage(); });
        });
      });
    });
  });
</script>

<style>
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .page-btn {
    font-size: 0.8125rem;
    padding: 0.375rem 0.875rem;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .page-btn:hover:not(:disabled) {
    border-color: var(--color-text-muted);
    color: var(--color-text-secondary);
  }

  .page-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .page-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .page-indicator {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    min-width: 7rem;
    text-align: center;
  }
</style>
