---
import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from './SEO.astro';
import PageStats from './PageStats.astro';

interface SortOption {
  key: string;
  label: string;
}

interface Props {
  title: string;
  intro: string;
  itemCount: number;
  itemLabel: string;
  statsExtra?: string;
  sortOptions?: SortOption[];
  defaultSort?: string;
  listId: string;
  emptyMessage: string;
  description: string;
}

const { title, intro, itemCount, itemLabel, statsExtra, sortOptions, defaultSort, listId, emptyMessage, description } = Astro.props;
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={description}
    type="website"
  />

  <div class="page-container">
    <header class="page-header">
      <h1 class="page-title">{title}</h1>
      <p class="page-intro">
        {intro}
      </p>
      <div class="page-controls">
        <PageStats text={`${itemCount} ${itemLabel}${statsExtra ? ` Â· ${statsExtra}` : ''}`} />
        {sortOptions && sortOptions.length > 0 && (
          <div class="sort-controls" role="group" aria-labelledby="sort-label">
            <span class="sort-label" id="sort-label">Sort by</span>
            {sortOptions.map((option) => (
              <button
                type="button"
                class:list={['sort-btn', { active: option.key === defaultSort }]}
                data-sort-key={option.key}
                aria-pressed={option.key === defaultSort}
              >
                {option.label}
              </button>
            ))}
          </div>
        )}
        <div role="status" class="sort-status visually-hidden" aria-live="polite" aria-atomic="true"></div>
      </div>
    </header>

    {itemCount > 0 ? (
      <div class="row-list" id={listId}>
        <slot />
      </div>
    ) : (
      <p class="empty-state">{emptyMessage}</p>
    )}
  </div>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.sort-controls').forEach((controls) => {
      const list = controls.closest('.page-container')?.querySelector('.row-list');
      if (!list) return;

      controls.querySelectorAll('.sort-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-sort-key');
          if (!key) return;

          controls.querySelectorAll('.sort-btn').forEach((b) => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');

          const statusEl = controls.closest('.page-container')?.querySelector('.sort-status');
          if (statusEl) statusEl.textContent = `Sorted by ${btn.textContent?.trim() ?? key}`;

          const items = [...list.querySelectorAll('.row-item')];
          const vals = items.map((el) => el.getAttribute('data-sort-' + key) || '');
          const numeric = vals.every((v) => v !== '' && !isNaN(Number(v)));

          const indices = items.map((_, i) => i);
          indices.sort((a, b) =>
            numeric ? Number(vals[b]) - Number(vals[a]) : vals[a].localeCompare(vals[b])
          );
          indices.forEach((i) => list.appendChild(items[i]));
        });
      });
    });
  });
</script>
