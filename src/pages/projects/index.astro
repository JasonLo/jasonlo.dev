---
import ListLayout from '../../components/ListLayout.astro';
import ArrowLink from '../../components/ArrowLink.astro';
import { getCollection } from 'astro:content';
import { pagesConfig } from '../../pages.config';

const allProjects = await getCollection('projects', ({ data }) => {
  return data.draft !== true;
});

// Default sort: featured first, then by year descending
const sortedProjects = [...allProjects].sort((a, b) => {
  if (a.data.featured !== b.data.featured) return b.data.featured ? 1 : -1;
  return b.data.year - a.data.year;
});

const displayTechMax = 3;
---

<ListLayout
  title={pagesConfig.projects.heading}
  intro={pagesConfig.projects.intro}
  description={pagesConfig.projects.description}
  itemCount={sortedProjects.length}
  itemLabel="projects"
  sortOptions={[
    { key: 'featured', label: 'Featured' },
    { key: 'recent', label: 'Recent' },
    { key: 'title', label: 'Title' }
  ]}
  defaultSort="featured"
  listId="projects-list"
  emptyMessage="No projects available yet."
>
  {sortedProjects.map((project) => (
    <a
      class="row-item"
      href={`/projects/${project.id}`}
      data-sort-featured={(project.data.featured ? 1e4 : 0) + project.data.year}
      data-sort-recent={project.data.year}
      data-sort-title={project.data.title.toLowerCase()}
    >
      <div class="row-year">{project.data.year}</div>
      <div class="row-body">
        <div class="row-title-line">
          <span class="row-title">{project.data.title}</span>
          {project.data.featured && (
            <span class="row-featured">Featured</span>
          )}
        </div>
        <span class="row-desc">{project.data.outcomeSummary}</span>
        <div class="row-meta">
          <span>{project.data.role}</span>
          <div class="row-tech">
            {project.data.techStack.slice(0, displayTechMax).map((tech) => (
              <span class="tech-badge">{tech}</span>
            ))}
            {project.data.techStack.length > displayTechMax && (
              <span class="tech-badge tech-more">+{project.data.techStack.length - displayTechMax}</span>
            )}
          </div>
        </div>
      </div>
      <div class="row-arrow">
        <ArrowLink text="" variant="muted" />
      </div>
    </a>
  ))}
</ListLayout>

<style>
  .row-title-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .row-featured {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    background: var(--color-accent);
    color: var(--color-bg);
    font-weight: 600;
    flex-shrink: 0;
  }

  .row-tech {
    display: flex;
    gap: 0.25rem;
  }

  .tech-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.4375rem;
    border-radius: 3px;
    background: var(--color-accent-muted);
    color: var(--color-text-secondary);
  }

  .tech-more {
    color: var(--color-text-muted);
  }
</style>
