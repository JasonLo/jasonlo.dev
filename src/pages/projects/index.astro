---
import ListLayout from '../../components/ListLayout.astro';
import { getCollection } from 'astro:content';
import { pagesConfig } from '../../pages.config';

const allProjects = await getCollection('projects', ({ data }) => {
  return data.draft !== true;
});

const sortedProjects = allProjects.sort((a, b) => {
  return b.data.year - a.data.year;
});

const displayTechMax = 3;
---

<ListLayout
  title={pagesConfig.projects.heading}
  intro={pagesConfig.projects.intro}
  description={pagesConfig.projects.description}
  itemCount={sortedProjects.length}
  itemLabel="projects"
  sortOptions={[
    { key: 'recent', label: 'Recent' },
    { key: 'title', label: 'Title' }
  ]}
  defaultSortKey="recent"
  listId="projects-list"
  emptyMessage="No projects available yet."
>
  {sortedProjects.map((project) => (
    <a
      class="row-item"
      href={`/projects/${project.id}`}
      data-year={project.data.year}
      data-title={project.data.title}
    >
      <div class="row-year">{project.data.year}</div>
      <div class="row-body">
        <div class="row-title-line">
          <span class="row-title">{project.data.title}</span>
          {project.data.featured && (
            <span class="row-featured">Featured</span>
          )}
        </div>
        <span class="row-desc">{project.data.outcomeSummary}</span>
        <div class="row-meta">
          <span>{project.data.role}</span>
          <div class="row-tech">
            {project.data.techStack.slice(0, displayTechMax).map((tech) => (
              <span class="tech-badge">{tech}</span>
            ))}
            {project.data.techStack.length > displayTechMax && (
              <span class="tech-badge tech-more">+{project.data.techStack.length - displayTechMax}</span>
            )}
          </div>
        </div>
      </div>
      <div class="row-arrow">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
      </div>
    </a>
  ))}
</ListLayout>

<style>
  .row-title-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .row-featured {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    background: var(--color-accent);
    color: var(--color-bg);
    font-weight: 600;
    flex-shrink: 0;
  }

  .row-tech {
    display: flex;
    gap: 0.25rem;
  }

  .tech-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.4375rem;
    border-radius: 3px;
    background: var(--color-accent-muted);
    color: var(--color-text-secondary);
  }

  .tech-more {
    color: var(--color-text-muted);
  }
</style>

<script>
  const list = document.getElementById('projects-list');
  const buttons = document.querySelectorAll<HTMLButtonElement>('.sort-btn');

  function sortList(key: string) {
    if (!list) return;
    const items = [...list.querySelectorAll<HTMLElement>('.row-item')];

    items.sort((a, b) => {
      if (key === 'title') {
        return (a.dataset.title ?? '').localeCompare(b.dataset.title ?? '');
      }
      // recent (default)
      return Number(b.dataset.year) - Number(a.dataset.year);
    });

    for (const item of items) {
      list.appendChild(item);
    }
  }

  buttons.forEach((btn) => {
    btn.addEventListener('click', () => {
      buttons.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      sortList(btn.dataset.sort ?? 'default');
    });
  });
</script>
